name: Server Setup (Temp)

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Setup task'
        required: true
        type: choice
        options:
          - setup-thaixtrade-ssh
          - test-ssh
          - cleanup

jobs:
  setup:
    name: Server Setup
    runs-on: ubuntu-latest

    steps:
      - name: Run setup via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 2m
          script: |
            TASK="${{ inputs.task }}"
            echo "Running task: $TASK"
            echo "Current user: $(whoami)"

            case "$TASK" in
              setup-thaixtrade-ssh)
                echo "=== Fixing sshd_config ==="
                sudo sed -i '/^PermitRootLogin no$/d' /etc/ssh/sshd_config
                sudo grep -n "PermitRootLogin" /etc/ssh/sshd_config

                echo "=== Setting up admin SSH key ==="
                mkdir -p ~/.ssh
                sudo cat /root/.ssh/thaixtrade_deploy.pub >> ~/.ssh/authorized_keys
                chmod 700 ~/.ssh
                chmod 600 ~/.ssh/authorized_keys

                echo "=== Check key added ==="
                grep thaixtrade ~/.ssh/authorized_keys

                echo "=== Setting up sudo for deploy ==="
                echo "$(whoami) ALL=(ALL) NOPASSWD: /usr/sbin/service, /usr/bin/systemctl" | sudo tee /etc/sudoers.d/deploy-user
                sudo chmod 440 /etc/sudoers.d/deploy-user

                echo "=== Restarting sshd ==="
                sudo systemctl restart sshd

                echo "=== DONE ==="
                ;;

              test-ssh)
                echo "=== whoami ==="
                whoami
                echo "=== SSH test ==="
                echo OK
                ;;

              cleanup)
                echo "This workflow can be deleted after setup is complete"
                ;;
            esac
